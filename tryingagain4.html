<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Inventory</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let existingData = []; // Array to store the existing data from the Excel file
        let productDetails = {}; // Object to store the current product details

        // Fixed product details
        const productDetailsFixed = {
            ProductNumber: 1234,  // Product Number
            SerialNumber: 1222,   // Serial Number
            ProductName: "ASDF",  // Fixed Product Name
        };

        // Region mapping table
        const regionMappings = [
            { name: "Dresden, Germany", latRange: [50.0, 52.0], lonRange: [12.0, 14.5] },
            { name: "Woodlands, Singapore", latRange: [1.2, 1.6], lonRange: [103.5, 104.0] },
            { name: "Beaverton, USA", latRange: [45.0, 46.0], lonRange: [-123.5, -122.0] },
            { name: "Taiwan", latRange: [22.0, 26.0], lonRange: [119.0, 123.0] }
        ];

        // Function to find the region name based on latitude and longitude
        function findRegionName(latitude, longitude) {
            for (const region of regionMappings) {
                if (
                    latitude >= region.latRange[0] && latitude <= region.latRange[1] &&
                    longitude >= region.lonRange[0] && longitude <= region.lonRange[1]
                ) {
                    return region.name;
                }
            }
            return "Unknown Area"; // Default if no match is found
        }

        // Function to display the data in the table
        function displayData() {
            const table = document.getElementById("data-table");
            table.innerHTML = ""; // Clear the table

            // Add table headers
            const headerRow = table.insertRow();
            ["Product Number", "Serial Number", "Product Name", "Timestamp", "Latitude", "Longitude", "Region"].forEach(header => {
                const th = document.createElement("th");
                th.textContent = header;
                headerRow.appendChild(th);
            });

            // Add existing data
            existingData.forEach(row => {
                const tr = table.insertRow();
                row.forEach(cell => {
                    const td = tr.insertCell();
                    td.textContent = cell;
                });
            });

            // Add new product details
            if (productDetails) {
                const newRow = table.insertRow();
                [
                    productDetails.ProductNumber,
                    productDetails.SerialNumber,
                    productDetails.ProductName,
                    productDetails.Timestamp,
                    productDetails.Latitude,
                    productDetails.Longitude,
                    productDetails.Region
                ].forEach(value => {
                    const td = newRow.insertCell();
                    td.textContent = value;
                });
            }
        }

        // Function to extract product details from the URL and update the table
        function extractProductDetailsFromURL() {
            const params = new URLSearchParams(window.location.search);

            // Extract product details from the URL query parameters
            productDetails = {
                ProductNumber: productDetailsFixed.ProductNumber,
                SerialNumber: productDetailsFixed.SerialNumber,
                ProductName: productDetailsFixed.ProductName,
                Latitude: parseFloat(params.get("Latitude")) || 0,
                Longitude: parseFloat(params.get("Longitude")) || 0,
                Region: "Unknown Area",
                Timestamp: params.get("Timestamp") || new Date().toISOString(),
            };

            // Determine the region based on latitude and longitude
            productDetails.Region = findRegionName(productDetails.Latitude, productDetails.Longitude);

            // Display the updated data
            displayData();
        }

        // Function to get geolocation details
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        const timestamp = new Date().toISOString(); // ISO 8601 timestamp

                        // Update geolocation and add the data
                        productDetails.Latitude = latitude;
                        productDetails.Longitude = longitude;
                        productDetails.Timestamp = timestamp;
                        productDetails.Region = findRegionName(latitude, longitude);

                        // Display the geolocation info on the page
                        displayData();
                    },
                    (error) => {
                        console.error("Geolocation Error:", error);
                        alert("Unable to retrieve your location. Please check your permissions.");
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Automatically run on page load
        window.onload = function() {
            // Extract product details from the URL
            extractProductDetailsFromURL();

            // Prompt for geolocation and update the data
            getLocation();
        };
    </script>
</head>
<body>
    <h1>ASDF</h1>
    <table id="data-table" border="1"></table>
</body>
</html>
